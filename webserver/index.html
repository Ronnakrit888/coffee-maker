<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>STM32 WebSocket Data Viewer</title>
    <!-- Use a specific, stable version -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.1.2/socket.io.js"></script>
    <style>
      /* Font import for Inter */
      @import url("https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap");

      body {
        font-family: "Inter", sans-serif;
        margin: 0;
        padding: 20px;
        background-color: #f4f4f9;
        color: #333;
      }
      .container {
        max-width: 1200px;
        margin: 0 auto;
        background-color: #fff;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
      }
      h1 {
        color: #2c3e50;
        border-bottom: 2px solid #eee;
        padding-bottom: 10px;
      }
      h2 {
        color: #34495e;
        margin-top: 20px;
        border-bottom: 1px solid #ddd;
        padding-bottom: 5px;
      }

      /* --- Two-Column Layout --- */
      .two-column-layout {
        display: flex;
        flex-direction: column;
        gap: 20px;
        margin-top: 20px;
      }
      @media (min-width: 768px) {
        .two-column-layout {
          flex-direction: row;
        }
      }
      .two-column-layout > div {
        flex: 1;
        padding: 15px;
        border-radius: 8px;
        background-color: #ecf0f1;
      }
      /* --- /Two-Column Layout --- */

      .data-item {
        margin-bottom: 10px;
        padding: 10px;
        background-color: #e9ecef;
        border-radius: 4px;
      }
      /* Custom style for the recommendation section */
      .recommendation-item {
        background-color: #e8f5e9; /* Light green background */
        border: 1px solid #c8e6c9; /* Subtle border */
        font-weight: bold;
      }
      .data-item strong {
        display: inline-block;
        width: 200px;
        color: #007bff;
      }
      .data-value {
        font-weight: bold;
        color: #333;
      }
      #connection-status {
        font-weight: bold;
      }
      #connection-status.connected {
        color: #27ae60;
      }
      #connection-status.disconnected {
        color: #e74c3c;
      }

      /* Log Console */
      #log-console {
        height: 120px;
        overflow-y: scroll;
        border: 1px solid #ccc;
        padding: 10px;
        background-color: #333;
        color: #0f0;
        font-family: monospace;
        border-radius: 4px;
      }

      /* Choices List Styling (and Summary Styling) */
      #available-choices ul {
        list-style: none;
        padding-left: 0;
      }
      #available-choices li {
        padding: 10px 15px;
        margin-bottom: 5px;
        border-radius: 6px;
        background-color: #f8f9fa;
        transition: background-color 0.2s, box-shadow 0.2s;
        border: 1px solid #ddd;
      }
      .selected-choice {
        background-color: #3498db !important;
        color: white;
        font-weight: bold;
        box-shadow: 0 2px 5px rgba(52, 152, 219, 0.5);
        border-color: #2980b9;
      }

      /* Summary Styling */
      .summary-title {
        font-size: 1.5em;
        color: #27ae60;
        margin-bottom: 15px;
        text-align: center;
      }
      .summary-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px;
        border-bottom: 1px dashed #ccc;
      }
      .summary-label {
        font-weight: 600;
        color: #34495e;
      }
      .summary-value {
        font-weight: bold;
        color: #2c3e50;
        background-color: #ecf0f1;
        padding: 4px 8px;
        border-radius: 4px;
      }

      /* TAMPING SPECIFIC STYLES */
      .tamping-data-block {
        background-color: #f7f9f9;
        border: 2px solid #3498db;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 20px;
      }
      .tamping-item {
        display: flex;
        justify-content: space-between;
        padding: 8px 0;
        border-bottom: 1px solid #eee;
      }
      .tamping-item:last-child {
        border-bottom: none;
      }
      .tamping-label {
        font-weight: 600;
        color: #2c3e50;
      }
      .tamping-value {
        font-weight: bold;
        color: #e67e22; /* Coffee color */
      }
      .tamping-description-value {
        color: #27ae60;
        font-style: italic;
      }
      /* --- /TAMPING SPECIFIC STYLES --- */

      /* --- MODAL STYLES --- */
      .modal {
        display: none; /* Hidden by default */
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0, 0, 0, 0.6); /* Black w/ opacity */
        backdrop-filter: blur(5px);
        -webkit-backdrop-filter: blur(5px);
        padding-top: 50px;
      }

      .modal-content {
        background-color: #fff;
        margin: 5% auto; /* 15% from the top and centered */
        padding: 30px;
        border: 1px solid #888;
        width: 90%;
        max-width: 500px;
        border-radius: 12px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        text-align: center;
        position: relative;
      }

      .progress-title {
        color: #e67e22; /* Coffee color */
        font-size: 1.8em;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
      }
      .progress-title span {
        margin-left: 10px;
      }

      /* Progress Bar Styling */
      .progress-bar-container {
        width: 100%;
        background-color: #ecf0f1;
        border-radius: 50px;
        margin: 20px 0;
        height: 30px;
        overflow: hidden;
        box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.2);
      }

      .progress-bar {
        height: 100%;
        width: 0;
        background-color: #3498db; /* Default Blue for progress */
        background-image: linear-gradient(
          45deg,
          rgba(255, 255, 255, 0.15) 25%,
          transparent 25%,
          transparent 50%,
          rgba(255, 255, 255, 0.15) 50%,
          rgba(255, 255, 255, 0.15) 75%,
          transparent 75%,
          transparent
        );
        background-size: 30px 30px;
        border-radius: 50px;
        transition: width 0.4s ease-in-out, background-color 0.4s;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .progress-text {
        font-size: 1.2em;
        font-weight: bold;
        color: #34495e;
        margin-top: 15px;
        height: 20px; /* reserve space to prevent CLS */
      }

      .progress-step-context {
        /* NEW STYLE */
        font-size: 0.9em;
        color: #7f8c8d;
        margin-bottom: 10px;
        font-style: italic;
        height: 18px; /* Reserve space */
      }
    </style>
  </head>
  <body>
    <!-- BREWING PROGRESS MODAL (UPDATED) -->
    <div id="brewing-modal" class="modal">
      <div class="modal-content">
        <div id="progress-modal-title" class="progress-title">
          ‚òïÔ∏è
          <span>Brewing Coffee...</span>
        </div>
        <!-- NEW: Context for the current step -->
        <div id="progress-step-context" class="progress-step-context">
          Initializing...
        </div>
        <div class="progress-bar-container">
          <div id="progress-bar" class="progress-bar" style="width: 0%"></div>
        </div>
        <!-- Note: This displays the main status text -->
        <div id="progress-text" class="progress-text">0% Complete</div>
        <p style="color: #7f8c8d; margin-top: 20px">
          <span id="progress-caption"
            >Please wait while your perfect cup is being prepared.</span
          >
        </p>
      </div>
    </div>
    <!-- END MODAL -->

    <div class="container">
      <h1>STM32 Real-Time Data (Node.js WebSocket)</h1>
      <p>
        Status:
        <span id="connection-status" class="disconnected">Connecting...</span>
      </p>

      <div class="two-column-layout">
        <!-- LEFT COLUMN: Status and Raw Data -->
        <div id="left-column">
          <h2>Current System Status</h2>
          <div id="mapped-data-display">
            <div class="data-item">
              <strong>Current State Name:</strong>
              <span id="state-name" class="data-value">Awaiting data...</span>
            </div>
            <div class="data-item">
              <strong>Current Selection:</strong>
              <span id="selection-name" class="data-value"
                >Awaiting data...</span
              >
            </div>

            <!-- Light Sensor Data (KEPT ON LEFT) -->
            <div class="data-item">
              <strong>Light Intensity (Lux):</strong>
              <span id="light-intensity-value" class="data-value"
                >Awaiting data...</span
              >
            </div>
          </div>

          <h2>Raw Data (IDs)</h2>
          <div id="data-display">
            <div class="data-item">
              <strong>Current State (ID):</strong>
              <span id="raw-state-id" class="data-value">Awaiting data...</span>
            </div>
            <div class="data-item">
              <strong>Counter Value (ID):</strong>
              <span id="raw-counter-id" class="data-value"
                >Awaiting data...</span
              >
            </div>
            <div class="data-item">
              <strong>Safety Halt Released:</strong>
              <span id="safety-halt" class="data-value">Awaiting data...</span>
            </div>
          </div>

          <div class="data-item">
            <strong>Last Update Received:</strong>
            <span id="last-updated">N/A</span>
          </div>
        </div>

        <!-- RIGHT COLUMN: Available Choices / Summary -->
        <div id="right-column">
          
          <!-- NEW: Recommended Menu (MOVED TO RIGHT) -->
          <!-- WRAPPED IN A CONTAINER FOR CONDITIONAL HIDING -->
          <div id="recommendation-container"> 
            <h2>Smart Menu Recommendation</h2>
            <div class="data-item recommendation-item" style="margin-bottom: 20px;">
              <strong>Recommended Menu:</strong>
              <span
                id="recommendation-value"
                class="data-value"
                style="color: #2e7d32;"
                >Awaiting light data...</span
              >
            </div>
          </div>
          
          <h2>Options for Current State / Order Summary</h2>
          <div id="available-choices">
            <p>
              Select a state on the STM32 to load the available options here.
            </p>
          </div>
        </div>
      </div>

      <!-- LOG CONSOLE (Stays full width below columns) -->
      <h2>STM32 UART Log</h2>
      <div id="log-console"></div>
    </div>

    <script>
      // Connect to the Node.js Socket.IO server running on localhost:5000
      const socket = io("http://127.0.0.1:5001");

      // --- GLOBAL STATE ---
      let lastSummaryData = null; // Store the last summary data
      let latestTampingData = null; // Store the last ADC data for real-time display

      // --- MAPPING ARRAYS ---
      // NOTE: STM32 States are: 0-4 (Selections), 5 (Safety Check), 6 (Shots), 7 (Summary), 8 (Brewing)
      const STATE_NAMES = [
        "Menu Selection",
        "Temperature Selection",
        "Coffee Beans Selection",
        "Tamping Level Selection",
        "Roast Level Selection",
        "Safety Check (Roast Temp)",
        "Shot Quantity Selection",
        "Final Order Summary",
        "Brewing", // State 8
        "Complete / Return to Menu", // State 9 (Placeholder for system returning to 0)
      ];

      const SELECTION_MAPS = {
        // State 0: Menu Selection
        0: [
          "Espresso",
          "Americano",
          "Cappuccino",
          "Latte",
          "Mocha",
          "Macchiato",
          "Flat White",
          "Affogato",
          "Ristretto",
          "Lungo",
        ],
        // State 1: Temperature Selection
        1: ["Hot", "Cold", "Blended"],
        // State 2: Coffee Beans Selection
        2: ["Arabica", "Robusta", "Liberica", "Excelsa", "Geisha", "Bourbon"],
        // State 3: Tamping Level Selection
        3: ["Very Light", "Light", "Medium", "Strong", "Very Strong"],
        // State 4: Roast Level Selection
        4: ["Light Roast", "Medium Roast", "Medium Dark Roast", "Dark Roast"],
        // State 5: Safety Check (No user selection, handled by C code)
        5: ["Confirm", "Go Back"],
        // State 6: Shot Quantity Selection (Index 0 is 1 shot, index 9 is 10 shots)
        6: [
          "1 Shot",
          "2 Shots",
          "3 Shots",
          "4 Shots",
          "5 Shots",
          "6 Shots",
          "7 Shots",
          "8 Shots",
          "9 Shots",
        ],
        // State 7: Final Order Summary
        7: "Review Complete",

        // State 8: Brewing
        8: "Brewing in Progress...",

        // State 9: Complete (Temporary state)
        9: "Process Complete",
      };

      // Safety Halt Index Mapping (for Summary Display)
      const SAFETY_STATUS = {
        0: "Passed (Safe)",
        1: "Halt Acknowledged/Released",
      };

      const TAMPING_DESCRIPTION = [
        "Mild, Delicate, Fruity Notes",
        "Smooth, Balanced, Light Body",
        "Rich, Full-bodied, Balanced",
        "Bold, Intense, Strong Flavor",
        "Very Bold, Robust, Maximum Extraction",
      ];

      // --- Tamping Logic Helper ---
      function getTampingIndex(adc_value) {
        if (adc_value < 820) return 0; // Very Light
        if (adc_value < 1639) return 1; // Light
        if (adc_value < 2458) return 2; // Medium
        if (adc_value < 3277) return 3; // Strong
        return 4; // Very Strong
      }

      function recommendMenuByLight(light_inten) {
        if (light_inten < 50) {
          return "Espresso | Ristretto | Americano"
        } else if (light_inten < 200) {
          return "Cappuccino | Latte | Flat White"
        } else if (light_inten < 500) {
          return "Mocha | Macchiato | Latte"
        } else if (light_inten < 1000) {
          return "Cold Americano | Iced Latte | Cold Cappuccino"
        } else {
          return "Blended Coffee | Cold Mocha | Affogato"
        }
      }

      // --- DOM Elements ---
      const lastUpdatedSpan = document.getElementById("last-updated");
      const statusSpan = document.getElementById("connection-status");
      const logConsole = document.getElementById("log-console");
      const stateNameSpan = document.getElementById("state-name");
      const selectionNameSpan = document.getElementById("selection-name");
      const rawStateIdSpan = document.getElementById("raw-state-id");
      const rawCounterIdSpan = document.getElementById("raw-counter-id");
      const safetyHaltSpan = document.getElementById("safety-halt");
      const availableChoicesDiv = document.getElementById("available-choices");

      // LIGHT ELEMENTS
      const lightIntensitySpan = document.getElementById("light-intensity-value");
      const recommendationSpan = document.getElementById("recommendation-value");
      // Recommendation container for conditional visibility
      const recommendationContainer = document.getElementById("recommendation-container");

      // Modal Elements
      const brewingModal = document.getElementById("brewing-modal");
      const modalTitle = document.getElementById("progress-modal-title");
      const progressBar = document.getElementById("progress-bar");
      const progressText = document.getElementById("progress-text");
      const progressCaption = document.getElementById("progress-caption");
      const progressStepContext = document.getElementById(
        "progress-step-context"
      );

      // --- Socket.IO Event Handlers ---
      socket.on("connect", () => {
        statusSpan.textContent = "Connected";
        statusSpan.className = "connected";
        console.log("WebSocket Connected!");
      });

      socket.on("disconnect", () => {
        statusSpan.textContent = "Disconnected";
        statusSpan.className = "disconnected";
        stateNameSpan.textContent = selectionNameSpan.textContent =
          "Connection Lost";
      });

      socket.on("stm32_update", (data) => {
        console.log("RECEIVED STATE UPDATE:", data);
        updateDisplay(data);

        // 1. Modal Control
        if (data.current_state === 8) {
          brewingModal.style.display = "block";
        } else if (data.current_state === 0) {
          // Reset state and hide modal when returning to menu
          brewingModal.style.display = "none";
          // Reset modal appearance
          progressBar.style.width = "0%";
          progressBar.style.backgroundColor = "#3498db";
          modalTitle.innerHTML = "‚òïÔ∏è<span>Brewing Coffee...</span>";
          progressText.textContent = "0% Complete";
          progressCaption.textContent =
            "Please wait while your perfect cup is being prepared.";
          progressStepContext.textContent = "Initializing...";
        } else {
          // Hide modal in all other non-brewing/non-reset states
          brewingModal.style.display = "none";
        }
      });

      // Light Data Handler
      socket.on("stm32_light_data", (data) => {
        // console.log("RECEIVED LIGHT DATA:", data); // Disabled to prevent excessive logging
        // 1. Update Intensity (Left Column)
        lightIntensitySpan.textContent = `${data.light_intensity} Lux`;
      
        recommendationSpan.textContent = recommendMenuByLight(data.light_intensity);
      });

      // Tamping ADC Data Handler
      socket.on("stm32_tamping_data", (data) => {
        console.log("RECEIVED TAMPING ADC DATA:", data);
        latestTampingData = data; // Store the raw data
        // If we are currently on the tamping screen (State 3), force a re-render
        if (rawStateIdSpan.textContent === "3") {
          // We no longer need the counter for state 3 selection, only to trigger update
          renderChoices(3, 0); // Pass a dummy counter
        }
      });

      socket.on("stm32_summary", (data) => {
        console.log("RECEIVED SUMMARY DATA:", data);
        lastSummaryData = data; // Store the summary

        // Force current_state to 7 (Summary State index)
        updateDisplay({
          current_state: 7,
          counter: 0,
          safety_halt_released: data.is_safety_idx,
          timestamp: data.timestamp,
        });
      });

      // Brewing progress handler to handle FAIL status
      socket.on("brewing_progress", (data) => {
        console.log("RECEIVED BREWING PROGRESS:", data);

        const status = data.status;
        const globalPercentage = data.global_percentage;
        // Replace underscores for better display
        const stepId = data.current_step_id.replace(/_/g, " ");

        // Ensure modal is visible during progress updates
        brewingModal.style.display = "block";

        // Always show the current step context
        progressStepContext.textContent = `Step: ${stepId.toUpperCase()}`;

        if (status === "FAIL") {
          // --- FAILURE STATE ---
          progressBar.style.width = `100%`; // Visually full bar to show the error point
          progressBar.style.backgroundColor = "#e74c3c"; // Red for failure
          modalTitle.innerHTML = "‚ùå<span>Brewing Failed!</span>";
          progressText.textContent = `ERROR: Failed during ${stepId.toUpperCase()} check.`;
          progressCaption.textContent =
            "See the STM32 UART Log below for the specific reason.";
        } else if (status === "SUCCESS" && globalPercentage === 100) {
          // --- FINAL SUCCESS STATE ---
          progressBar.style.width = `100%`;
          progressBar.style.backgroundColor = "#2ecc71"; // Green
          modalTitle.innerHTML = "‚úÖ<span>Completed!</span>";
          progressText.textContent = "DONE! Enjoy your perfect cup! üòã";
          progressCaption.textContent = "Returning to the main menu shortly.";
        } else {
          // --- IN_PROGRESS STATE ---
          progressBar.style.width = `${globalPercentage}%`;
          // Color coding: Orange for Pre-Checks (0-25%), Blue for Grinding/Brewing (25%-100%)
          progressBar.style.backgroundColor =
            globalPercentage <= 25 ? "#e67e22" : "#3498db";
          modalTitle.innerHTML = "‚òïÔ∏è<span>Brewing Coffee...</span>";

          progressText.textContent = `Global Progress: ${globalPercentage}%`;
          progressCaption.textContent =
            "Please wait while your perfect cup is being prepared.";
        }
      });

      socket.on("log_message", (data) => {
        const msg = data.msg;
        const logEntry = document.createElement("div");
        logEntry.textContent = msg;
        logConsole.appendChild(logEntry);
        logConsole.scrollTop = logConsole.scrollHeight;
      });

      // --- UI Update Function ---
      function updateDisplay(data) {
        const currentState = data.current_state;
        const counter = data.counter;

        // 1. RAW Data Update
        const lastUpdatedTime = new Date(
          data.timestamp * 1000
        ).toLocaleTimeString("en-US", { hour12: false });
        lastUpdatedSpan.textContent = lastUpdatedTime;
        rawStateIdSpan.textContent = currentState;
        rawCounterIdSpan.textContent = counter;

        safetyHaltSpan.textContent =
          data.safety_halt_released === 1
            ? "YES (1) - HALTED"
            : "NO (0) - SAFE";
        safetyHaltSpan.style.color =
          data.safety_halt_released === 1 ? "#e74c3c" : "#27ae60";

        // 2. MAPPED/DESCRIPTIVE Data Update

        // A. Current State Name
        stateNameSpan.textContent =
          STATE_NAMES[currentState] || `Unknown State (${currentState})`;

        // B. Current Selection Name
        let selectionName = "N/A";
        const map = SELECTION_MAPS[currentState];

        if (map) {
          // Special handling for State 3 (Tamping) since the selection is *external* (ADC)
          if (currentState === 3 && latestTampingData) {
             const tampingIndex = getTampingIndex(latestTampingData.adc_value);
             selectionName = map[tampingIndex] || `Unknown Index (${tampingIndex})`;
          } else if (Array.isArray(map)) {
            selectionName = map[counter] || `Unknown Index (${counter})`;
          } else {
            selectionName = map;
          }
        } else {
          // Handle states that don't have a map
          selectionName = `No Selection Map for State ${currentState}`;
        }

        selectionNameSpan.textContent = selectionName;

        // 3. Conditional Recommendation Visibility
        // Hide recommendation if the state is anything other than the initial Menu Selection (State 0)
        if (currentState > 0) {
            recommendationContainer.style.display = 'none';
        } else {
            recommendationContainer.style.display = 'block';
        }

        // 4. Render Available Choices/Summary in the right column
        renderChoices(currentState, counter);
      }

      // --- Tamping Data Renderer (UPDATED: Removed selection prompt) ---
      function renderTampingData(adcValue) {
        const index = getTampingIndex(adcValue);
        const description = TAMPING_DESCRIPTION[index] || "N/A";

        return `
                <h3>Real-Time Tamping Feedback</h3>
                <div class="tamping-data-block">
                    <div class="tamping-item">
                        <span class="tamping-label">ADC Value:</span>
                        <span class="tamping-value">${adcValue}</span>
                    </div>
                    <div class="tamping-item">
                        <span class="tamping-label">Calculated Level:</span>
                        <span class="tamping-value">${index}</span>
                    </div>
                    <div class="tamping-item">
                        <span class="tamping-label">Flavor Profile:</span>
                        <span class="tamping-description-value">${description}</span>
                    </div>
                </div>
            `; // Removed <hr> and selection prompt
      }

      // --- Choice Rendering Function (UPDATED: Added return for State 3) ---
      function renderChoices(state, counter) {
        availableChoicesDiv.innerHTML = ""; // Clear previous content

        // Check for State 7 (Summary State index) to trigger summary render
        if (state === 7 && lastSummaryData) {
          renderSummary(lastSummaryData);
          return;
        } else if (state === 7) {
          availableChoicesDiv.innerHTML =
            '<p class="summary-title" style="color: #f39c12;">Awaiting Final Order Summary data...</p>';
          return;
        }

        // Tamping State (State 3) requires special rendering - now only shows ADC data
        if (state === 3) {
          if (latestTampingData) {
            // Render the real-time ADC data block first
            availableChoicesDiv.innerHTML += renderTampingData(
              latestTampingData.adc_value
            );
          } else {
            availableChoicesDiv.innerHTML +=
              '<h3>Real-Time Tamping Feedback</h3><p style="font-style: italic; color: #7f8c8d;">Awaiting ADC data...</p>';
          }
          // IMPORTANT: Return here to skip rendering the selection list
          return; 
        }

        const map = SELECTION_MAPS[state];
        let choicesArray = [];

        // Identify which map to use for listing choices
        if (Array.isArray(map)) {
          choicesArray = map;
        } else if (typeof map === "string") {
          // Handle static states (8: Brewing, 9: Complete)
          availableChoicesDiv.innerHTML += `<p style="font-style: italic; color: #7f8c8d; text-align: center;">${map}</p>`;
          return;
        } else {
          // Fallback for states with no definition
          availableChoicesDiv.innerHTML = `<p style="font-style: italic; color: #7f8c8d;">No options to display for this state.</p>`;
          return;
        }

        const ul = document.createElement("ul");

        choicesArray.forEach((choiceName, index) => {
          const li = document.createElement("li");
          li.textContent = choiceName;

          // Check if the current choice index matches the received counter value
          if (index === counter) {
            li.className = "selected-choice";
          }
          ul.appendChild(li);
        });

        availableChoicesDiv.appendChild(ul);
      }

      // --- Summary Rendering Function ---
      function renderSummary(summaryData) {
        const menuName = SELECTION_MAPS[0][summaryData.menu_idx] || "N/A";
        const tempName = SELECTION_MAPS[1][summaryData.temp_idx] || "N/A";
        const beanName = SELECTION_MAPS[2][summaryData.bean_idx] || "N/A";
        // Tamping (State 3) is index 3 in SELECTION_MAPS
        const tampingName = SELECTION_MAPS[3][summaryData.tamping_idx] || "N/A";
        const roastName = SELECTION_MAPS[4][summaryData.roast_idx] || "N/A";
        const shots = summaryData.shots; // Already 1-indexed
        const safetyStatus = SAFETY_STATUS[summaryData.is_safety_idx] || "N/A";

        availableChoicesDiv.innerHTML = `
                <div class="summary-title">Order Confirmed!</div>
                <div class="summary-item">
                    <span class="summary-label">Beverage Type:</span>
                    <span class="summary-value">${menuName}</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">Temperature:</span>
                    <span class="summary-value">${tempName}</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">Coffee Bean:</span>
                    <span class="summary-value">${beanName}</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">Roast Level:</span>
                    <span class="summary-value">${roastName}</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">Tamping Force:</span>
                    <span class="summary-value">${tampingName}</span>
                </div>
                <div class="summary-item" style="border-bottom: none; margin-top: 10px; padding-bottom: 0;">
                    <span class="summary-label" style="font-size: 1.1em; color: #e67e22;">Shot Quantity:</span>
                    <span class="summary-value" style="font-size: 1.1em; background-color: #f1c40f;">${shots} ${
          shots > 1 ? "Shots" : "Shot"
        }</span>
                </div>
                <hr style="border: 0; border-top: 2px solid #bdc3c7; margin: 15px 0;">
                <div class="summary-item">
                    <span class="summary-label">Roast Temp Check:</span>
                    <span class="summary-value" style="color: ${
                      summaryData.is_safety_idx === 0 ? "#27ae60" : "#e74c3c"
                    }; background-color: #fff; border: 1px solid currentColor;">${safetyStatus}</span>
                </div>
            `;
      }
    </script>
  </body>
</html>